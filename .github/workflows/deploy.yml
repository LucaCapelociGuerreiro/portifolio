name: 'Deploy Portfolio to Oracle Cloud'

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'

  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  DOCKER_REGISTRY: 'ghcr.io'
  IMAGE_NAME: 'portfolio-app'

  # Server Configuration
  SERVER_HOST: ${{ secrets.ORACLE_SERVER_HOST }}
  SERVER_USER: ${{ secrets.ORACLE_SERVER_USER || 'ubuntu' }}
  SSH_PRIVATE_KEY: ${{ secrets.ORACLE_SSH_PRIVATE_KEY }}

  # Application Configuration
  APP_ENV: 'production'
  APP_VERSION: ${{ github.sha }}

  # Monitoring
  PROMETHEUS_ENABLED: 'true'
  GRAFANA_ENABLED: 'true'

permissions:
  contents: read
  packages: write
  security-events: write
  actions: read
  id-token: write

jobs:
  # Build & Push Docker Image
  build-and-push:
    name: ðŸ—ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Login to GHCR
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin

      - name: ðŸ³ Build and push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_URI=${{ env.DOCKER_REGISTRY }}/${{ secrets.GHCR_USER }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG
          
          echo "ðŸ“¦ Construindo imagem $IMAGE_URI..."
          docker build -t $IMAGE_URI ./meu-portifolio  # Verifique se o contexto estÃ¡ correto aqui!
          docker push $IMAGE_URI

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

  # Deploy to Oracle Cloud
  deploy-oracle:
    name: ðŸš€ Deploy to Oracle Cloud
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ORACLE_SSH_PRIVATE_KEY }}

      - name: ðŸ“‹ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ORACLE_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to Oracle Cloud
        id: deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ORACLE_SSH_USER }}@${{ secrets.ORACLE_SERVER_IP }} << 'EOF'
            # Deploy script here
          EOF

  # Post-Deploy Monitoring
  notify:
    name: ðŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [deploy-oracle]
    if: always()

    steps:
      - name: ðŸ“§ Notify Success
        if: needs.deploy-oracle.result == 'success'
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ðŸŒ URL: http://${{ secrets.ORACLE_SERVER_IP }}"
          echo "ðŸ“Š Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Autor: ${{ github.actor }}"

      - name: ðŸš¨ Notify Failure
        if: needs.deploy-oracle.result == 'failure'
        run: |
          echo "âŒ Deploy falhou!"
          echo "ðŸ“Š Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Autor: ${{ github.actor }}"
          echo "ðŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
