#cloud-config
# ==============================================================================
# CLOUD-INIT CONFIGURATION - ORACLE CLOUD INSTANCE
# ==============================================================================
# ConfiguraÃ§Ã£o automÃ¡tica do servidor Oracle Cloud
# Analista DevOps SÃªnior - AutomaÃ§Ã£o de Infraestrutura

# Atualizar pacotes na inicializaÃ§Ã£o
package_update: true
package_upgrade: true

# Pacotes a serem instalados
packages:
  - curl
  - wget
  - git
  - htop
  - vim
  - unzip
  - jq
  - tree
  - net-tools
  - firewalld
  - fail2ban
  - logrotate
  - cron
  - rsync
  - ca-certificates
  - gnupg
  - lsb-release

# ConfiguraÃ§Ãµes do sistema
system_info:
  default_user:
    name: opc
    groups: [wheel, docker]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash

# Configurar timezone
timezone: America/Sao_Paulo

# Configurar locale
locale: en_US.UTF-8

# Scripts a serem executados
runcmd:
  # ==============================================================================
  # CONFIGURAÃ‡ÃƒO INICIAL DO SISTEMA
  # ==============================================================================
  
  # Configurar hostname
  - hostnamectl set-hostname portfolio-server
  - echo "127.0.0.1 portfolio-server" >> /etc/hosts
  
  # Configurar firewall
  - systemctl enable firewalld
  - systemctl start firewalld
  - firewall-cmd --permanent --add-service=ssh
  - firewall-cmd --permanent --add-service=http
  - firewall-cmd --permanent --add-service=https
  - firewall-cmd --permanent --add-port=3000/tcp
  - firewall-cmd --permanent --add-port=9090/tcp
  - firewall-cmd --permanent --add-port=3001/tcp
  - firewall-cmd --permanent --add-port=9100/tcp
  - firewall-cmd --reload
  
  # Configurar fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # ==============================================================================
  # INSTALAÃ‡ÃƒO DO DOCKER
  # ==============================================================================
  
  # Remover versÃµes antigas do Docker
  - yum remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine
  
  # Adicionar repositÃ³rio Docker
  - yum install -y yum-utils
  - yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  
  # Instalar Docker
  - yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  
  # Iniciar e habilitar Docker
  - systemctl enable docker
  - systemctl start docker
  
  # Adicionar usuÃ¡rio opc ao grupo docker
  - usermod -aG docker opc
  
  # Instalar Docker Compose standalone
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
  
  # ==============================================================================
  # CONFIGURAÃ‡ÃƒO DE MONITORAMENTO
  # ==============================================================================
  
  # Criar diretÃ³rios para monitoramento
  - mkdir -p /opt/monitoring/{prometheus,grafana,node-exporter}
  - chown -R opc:opc /opt/monitoring
  
  # Instalar Node Exporter
  - |
    cd /tmp
    wget https://github.com/prometheus/node_exporter/releases/latest/download/node_exporter-1.6.1.linux-amd64.tar.gz
    tar xvfz node_exporter-1.6.1.linux-amd64.tar.gz
    cp node_exporter-1.6.1.linux-amd64/node_exporter /usr/local/bin/
    chmod +x /usr/local/bin/node_exporter
    rm -rf node_exporter-1.6.1.linux-amd64*
  
  # ==============================================================================
  # CONFIGURAÃ‡ÃƒO DE SEGURANÃ‡A
  # ==============================================================================
  
  # Configurar SSH mais seguro
  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart sshd
  
  # Configurar limites do sistema
  - echo "* soft nofile 65536" >> /etc/security/limits.conf
  - echo "* hard nofile 65536" >> /etc/security/limits.conf
  - echo "* soft nproc 32768" >> /etc/security/limits.conf
  - echo "* hard nproc 32768" >> /etc/security/limits.conf
  
  # OtimizaÃ§Ãµes do kernel
  - echo "vm.max_map_count=262144" >> /etc/sysctl.conf
  - echo "net.core.somaxconn=65535" >> /etc/sysctl.conf
  - echo "net.ipv4.tcp_max_syn_backlog=65535" >> /etc/sysctl.conf
  - sysctl -p
  
  # ==============================================================================
  # CONFIGURAÃ‡ÃƒO DE LOGS
  # ==============================================================================
  
  # Configurar logrotate para Docker
  - |
    cat > /etc/logrotate.d/docker << 'EOF'
    /var/lib/docker/containers/*/*.log {
      rotate 7
      daily
      compress
      size=1M
      missingok
      delaycompress
      copytruncate
    }
    EOF
  
  # ==============================================================================
  # PREPARAÃ‡ÃƒO PARA DEPLOY
  # ==============================================================================
  
  # Criar diretÃ³rio para deploy
  - mkdir -p /home/opc/portfolio-deploy
  - chown -R opc:opc /home/opc/portfolio-deploy
  
  # Criar script de health check
  - |
    cat > /home/opc/health-check.sh << 'EOF'
    #!/bin/bash
    # Health check script para a aplicaÃ§Ã£o
    
    APP_URL="http://localhost:80"
    MAX_RETRIES=5
    RETRY_INTERVAL=10
    
    for i in $(seq 1 $MAX_RETRIES); do
        if curl -f $APP_URL > /dev/null 2>&1; then
            echo "$(date): AplicaÃ§Ã£o estÃ¡ saudÃ¡vel"
            exit 0
        else
            echo "$(date): Tentativa $i/$MAX_RETRIES falhou, aguardando $RETRY_INTERVAL segundos..."
            sleep $RETRY_INTERVAL
        fi
    done
    
    echo "$(date): AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo apÃ³s $MAX_RETRIES tentativas"
    exit 1
    EOF
  
  - chmod +x /home/opc/health-check.sh
  - chown opc:opc /home/opc/health-check.sh
  
  # Criar script de backup
  - |
    cat > /home/opc/backup.sh << 'EOF'
    #!/bin/bash
    # Script de backup para a aplicaÃ§Ã£o
    
    BACKUP_DIR="/home/opc/backups"
    DATE=$(date +%Y%m%d_%H%M%S)
    APP_DIR="/home/opc/portfolio-deploy"
    
    mkdir -p $BACKUP_DIR
    
    # Backup dos dados da aplicaÃ§Ã£o
    if [ -d "$APP_DIR" ]; then
        tar -czf "$BACKUP_DIR/portfolio_backup_$DATE.tar.gz" -C "$APP_DIR" .
        echo "$(date): Backup criado: portfolio_backup_$DATE.tar.gz"
    fi
    
    # Backup dos volumes Docker
    docker run --rm -v portfolio_app_data:/data -v $BACKUP_DIR:/backup alpine tar -czf /backup/docker_volumes_$DATE.tar.gz -C /data .
    
    # Limpar backups antigos (manter apenas os Ãºltimos 7 dias)
    find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
    
    echo "$(date): Backup concluÃ­do"
    EOF
  
  - chmod +x /home/opc/backup.sh
  - chown opc:opc /home/opc/backup.sh
  
  # Configurar cron para backup diÃ¡rio
  - echo "0 2 * * * /home/opc/backup.sh >> /var/log/backup.log 2>&1" | crontab -u opc -
  
  # ==============================================================================
  # CONFIGURAÃ‡ÃƒO DE MONITORAMENTO COM SYSTEMD
  # ==============================================================================
  
  # Criar serviÃ§o systemd para Node Exporter
  - |
    cat > /etc/systemd/system/node-exporter.service << 'EOF'
    [Unit]
    Description=Node Exporter
    Wants=network-online.target
    After=network-online.target
    
    [Service]
    User=opc
    Group=opc
    Type=simple
    ExecStart=/usr/local/bin/node_exporter --web.listen-address=:9100
    Restart=always
    RestartSec=3
    
    [Install]
    WantedBy=multi-user.target
    EOF
  
  - systemctl daemon-reload
  - systemctl enable node-exporter
  - systemctl start node-exporter
  
  # ==============================================================================
  # CONFIGURAÃ‡Ã•ES FINAIS
  # ==============================================================================
  
  # Criar arquivo de informaÃ§Ãµes do sistema
  - |
    cat > /home/opc/system-info.txt << 'EOF'
    ===========================================
    PORTFOLIO SERVER - ORACLE CLOUD
    ===========================================
    
    Servidor configurado automaticamente via Terraform + Cloud-Init
    
    ServiÃ§os instalados:
    - Docker & Docker Compose
    - Node Exporter (porta 9100)
    - Firewall configurado
    - Fail2ban ativo
    - Backup automÃ¡tico (diÃ¡rio Ã s 2h)
    
    DiretÃ³rios importantes:
    - /home/opc/portfolio-deploy (aplicaÃ§Ã£o)
    - /home/opc/backups (backups)
    - /opt/monitoring (monitoramento)
    
    Scripts Ãºteis:
    - /home/opc/health-check.sh
    - /home/opc/backup.sh
    
    Logs importantes:
    - /var/log/cloud-init.log
    - /var/log/cloud-init-output.log
    - /var/log/backup.log
    
    Para verificar status dos serviÃ§os:
    - systemctl status docker
    - systemctl status node-exporter
    - systemctl status firewalld
    - systemctl status fail2ban
    
    ===========================================
    EOF
  
  - chown opc:opc /home/opc/system-info.txt
  
  # Configurar motd
  - |
    cat > /etc/motd << 'EOF'
    
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
    â•šâ•â•      â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•      â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â• â•šâ•â•â•â•â•â• 
    
    ðŸš€ Oracle Cloud - Portfolio Server
    ðŸ“Š Monitoramento: Node Exporter ativo na porta 9100
    ðŸ³ Docker: Pronto para deploy
    ðŸ”’ SeguranÃ§a: Firewall + Fail2ban ativos
    ðŸ’¾ Backup: AutomÃ¡tico diÃ¡rio Ã s 2h
    
    ðŸ“‹ Para informaÃ§Ãµes do sistema: cat ~/system-info.txt
    ðŸ” Para verificar saÃºde: ~/health-check.sh
    
    EOF
  
  # Reiniciar serviÃ§os necessÃ¡rios
  - systemctl restart rsyslog
  - systemctl restart cron
  
  # Log de conclusÃ£o
  - echo "$(date): Cloud-init configuration completed successfully" >> /var/log/cloud-init-custom.log

# Arquivos a serem criados
write_files:
  # ConfiguraÃ§Ã£o do fail2ban para SSH
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 3
      
      [sshd]
      enabled = true
      port = ssh
      logpath = /var/log/secure
      maxretry = 3
      bantime = 3600
    owner: root:root
    permissions: '0644'
  
  # ConfiguraÃ§Ã£o personalizada do Docker daemon
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "storage-driver": "overlay2",
        "live-restore": true,
        "userland-proxy": false,
        "experimental": false,
        "metrics-addr": "127.0.0.1:9323",
        "experimental": true
      }
    owner: root:root
    permissions: '0644'
  
  # Script de monitoramento de recursos
  - path: /home/opc/monitor-resources.sh
    content: |
      #!/bin/bash
      # Script de monitoramento de recursos do sistema
      
      echo "=== MONITORAMENTO DE RECURSOS - $(date) ==="
      echo
      
      echo "CPU Usage:"
      top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4"%"}'
      echo
      
      echo "Memory Usage:"
      free -h
      echo
      
      echo "Disk Usage:"
      df -h
      echo
      
      echo "Docker Containers:"
      docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      echo
      
      echo "Docker Images:"
      docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
      echo
      
      echo "Network Connections:"
      netstat -tuln | grep LISTEN
      echo
      
      echo "System Load:"
      uptime
      echo
    owner: opc:opc
    permissions: '0755'

# ConfiguraÃ§Ãµes finais
final_message: |
  ========================================
  ðŸŽ‰ ORACLE CLOUD SERVER READY! ðŸŽ‰
  ========================================
  
  âœ… Sistema configurado com sucesso
  âœ… Docker instalado e configurado
  âœ… Monitoramento ativo
  âœ… SeguranÃ§a configurada
  âœ… Backup automÃ¡tico configurado
  
  ðŸš€ Servidor pronto para deploy!
  
  PrÃ³ximos passos:
  1. Configure os secrets no GitHub Actions
  2. Execute o pipeline de deploy
  3. Acesse a aplicaÃ§Ã£o via IP pÃºblico
  
  ========================================

# Reinicializar apÃ³s configuraÃ§Ã£o
power_state:
  mode: reboot
  message: "Reiniciando apÃ³s configuraÃ§Ã£o inicial"
  timeout: 30
  condition: true